# E2E 시나리오 테스트 (포털↔게이트웨이↔서비스↔Redis/MQTT)

## 시나리오 E2E-001: 신규 사용자 통합 플로우
- 전제: 유효 등급 코드, 신규 사용자
- 절차:
  1) POST /auth/check-duplicates → 모두 사용 가능
  2) POST /auth/register → 201
  3) POST /auth/login → 큐 진입 응답(tid, clientId)
  4) MQTT 구독(queue/portal/{userId}/status, ready)
  5) READY 수신 후 POST /auth/finalize
- 검증:
  - READY 이전에는 finalize 금지
  - finalize 후 Redis에서 user:{userId} 상태 제거
  - access/refresh 토큰 수령

## 시나리오 E2E-002: 기존 세션 유지(새로고침)
- 전제: 로그인 후 동일 clientId 재시도
- 절차: POST /auth/login 재요청
- 검증: 기존 tid 유지, 즉시 토큰 발급, 큐 생략

## 시나리오 E2E-003: 10분 만료 후 재접속
- 전제: lastSeen > 10분
- 절차: 로그인 → 큐 재등록
- 검증: 신규 ZADD 반영, status=PENDING

## 시나리오 E2E-004: 다른 클라이언트 접속(기존 튕김)
- 전제: 동일 userId, 다른 clientId
- 절차: 새 기기에서 로그인
- 검증: MQTT cancelled 기존 기기에 발행, 새 clientId로 업데이트

## 시나리오 E2E-005: ADMIN 직행
- 전제: role=ADMIN
- 검증: 큐 미사용, 즉시 토큰 발급

## 시나리오 E2E-006: 우선순위 정확성
- 전제: VIP/PREMIUM/NORMAL 혼합 100명
- 검증: ZRANGE 순서가 우선순위*1e9+timestamp 기준과 일치

## 시나리오 E2E-007: 로그아웃과 세션 정리
- 절차: POST /auth/logout
- 검증: refresh_tokens:{userId} 삭제, user:{userId} 제거, sse:clients 정리

---

부록 A. 자동화 제안
- Playwright/Node: 회원가입→로그인→MQTT READY→finalize 스크립트
- Retry/Timeout: MQTT 대기 최대 60초, 재시도 백오프

부록 B. 산출물
- 실행 로그, 캡처, Redis 키 스냅샷, MQTT 캡처
